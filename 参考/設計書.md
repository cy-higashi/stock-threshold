# 在庫しきい値アラート 設計書

本設計は [要件定義書.md](要件定義書.md) に基づく。

## 1. 目的

ポータルが指定した最低在庫数未満の商品があった場合、CyberRecords の ChatWork にアラートを出し、担当者がポータル側に連携することで、在庫切れによる販売機会損失を防止する。

## 2. 要件との対応（要件概要）


| 項目      | 内容                                                                                                     |
| ------- | ------------------------------------------------------------------------------------------------------ |
| 最低在庫の設定 | ポータルが指定する商品と最低在庫数は、ポータルごとの CSV または Excel で設定する。`portals.{ポータル名}.min_stock_base_path` に CSV/XLSX ファイルへの**直接パス**を指定する。空文字のポータルは処理対象外とする。 |
| 在庫データ   | 引数で渡したポータル名のディレクトリ配下の CSV / TSV / txt / XLSX から、商品コードで一意に合算した在庫数を取得する。Choice ポータルは TSV 2 ファイル（末尾 `_change_stock` で判別）を第一カラムでジョインする特殊処理を行う。 |
| アラート条件  | ポータルごとに、合算在庫数が最低在庫数以下（<=）の場合に ChatWork へアラート通知する。最低在庫数 CSV に存在しない返礼品コードはスキップする。                                                        |
| 実行頻度    | 現時点では 1 日 1 回の実行を想定（タスクスケジューラ等で呼び出す）。                                                                  |


## 3. 処理フロー

1. **入力**
  - コマンドライン引数: **ポータル名のディレクトリ**（必須）。在庫データ（CSV/TSV/txt/XLSX）が格納されたフォルダのパス。**ディレクトリ名**で setting.json のポータル定義と、最低在庫定義ファイル（CSV/XLSX）を検索する。
  - 設定ファイル: `setting.json`（任意で第 2 引数でパス指定、省略時は実行ファイル同階層の `setting.json`）
  - 最低在庫: 実行のたびに `portals.{ポータル名}.min_stock_base_path` で指定した CSV または XLSX ファイルから読み出す。**min_stock_base_path が空文字のポータルは処理対象外とする。**
2. **処理**
  - 渡したディレクトリの**ディレクトリ名**をポータル名とみなし、setting.json の `portals` から同名のポータル定義を検索する。
  - 当該ポータルについて:
    - 渡したディレクトリ内の CSV / TSV / txt / XLSX を、setting.json で定義した商品コード・在庫数のカラム（名または列番号）でパースし、商品コードごとに在庫数を合算する。**Choice ポータル**は `tsv_join_mode` により、2 つの TSV を第一カラムでジョインする特殊処理を行う。
    - `portals.{ポータル名}.min_stock_base_path` で指定した CSV / XLSX ファイルから商品コードと最低在庫数を読み出す（1 行目をヘッダーとし、「返礼品コード」等と「最低在庫数」列を参照）。
    - 合算在庫数 <= 最低在庫数 の商品をアラート対象としてリストに追加する。**最低在庫数 CSV に存在しない返礼品コードはスキップする。**
  - アラートが 1 件以上ある場合、setting.json に記載した ChatWork の API ドメイン・エンドポイントを用いてメッセージを送信する。ChatWork API は `application/x-www-form-urlencoded` 形式で `body` パラメータにメッセージを設定して送信する。
3. **出力**
  - ChatWork ルームへ、ポータル名・商品コード・現在の合算在庫数・最低在庫数・不足数を含むアラートメッセージを送信する。

## 4. 設定ファイル（setting.json）

- **ChatWork API**
  - `chatwork.api_base_url`: API のベース URL（例: `https://api.chatwork.com`）
  - `chatwork.room_id`: 送信先ルーム ID
  - `chatwork.message_endpoint`: メッセージ送信エンドポイント（例: `/v2/rooms/{room_id}/messages`）
  - `chatwork.mention_members`: メンション対象メンバーの配列（任意）。各要素は `name`（表示名）と `account_id`（ChatWork のアカウント ID）。メッセージ先頭に `[To:account_id] 名前` が付与される。複数指定可。
  - トークンは設定ファイルに持たず、環境変数 `CHATWORK_API_TOKEN` で渡す。
  - **ポータル別**: `portals.{ポータル名}` の形式。ポータル名はコマンドラインで渡す「ポータル名のディレクトリ」の**ディレクトリ名**を小文字に正規化して一致させる。
  - **min_stock_base_path**: 当該ポータルの最低在庫数定義ファイル（CSV または XLSX）への**直接パス**。空文字の場合は当該ポータルは処理対象外となる（複数ポータル一括実行時にスキップされる）。
  - **mapping**（各ポータル配下）:
    - **ヘッダーあり**（通常）: `product_code_column`（商品コードのカラム名）, `stock_column`（在庫数のカラム名）
    - **ヘッダーなし**: `has_header: false`, `product_code_column_index`, `stock_column_index`（0 始まり）
    - **Choice 専用（tsv_join_mode）**: `tsv_join_mode: true` を指定し、`details_product_code_column_index`（返礼品コード列、0-based、103 列目なら 102）, `change_stock_column_index`（在庫数列、0-based、4 列目なら 3）を mapping に設定する。
  - **CSV/TSV/TXT の文字コード・デリミタ**: 設定では指定しない。UTF-8 → UTF-8 BOM → CP932 の順で自動判別し、区切りは先頭行からタブ/カンマを自動判定する。

## 5. ディレクトリ・ファイル構成

1 ポータル単位の実行は `main.py`、複数ポータル一括実行は `run_all_portals.bat` / `run_all_portals.py` を使用する。それ以外の Python モジュールは `app` 配下に配置する。


| パス                        | 説明                                                                                        |
| ------------------------- | ----------------------------------------------------------------------------------------- |
| `main.py`                 | **ポータル単体のエントリポイント**。引数でポータル名のディレクトリを受け取り、そのディレクトリ名で setting.json と最低在庫 CSV/XLSX を検索してフローを実行。 |
| `run_all_portals.bat`     | **複数ポータル一括実行用**。引数なしの場合は `G:\共有ドライブ\★OD\99_Ops\アーカイブ(Stock)` 配下の直近日付（yyyy-MM-dd）を対象とする。引数ありの場合は第 1 引数をベースディレクトリとして使用。配下のポータル名ディレクトリのうち、min_stock_base_path が空でないものをアルファベット順でシリアルに main.py へ渡して処理する。 |
| `run_all_portals.py`      | run_all_portals.bat から呼ばれる。setting.json を読み、対象ポータルを抽出して main.py を 1 ポータルずつ起動する。 |
| `setting.json`            | 上記の設定。ChatWork のドメイン・エンドポイント、ポータル別カラム定義・min_stock_base_path など。                                                |
| `requirements.txt`        | 依存ライブラリ（openpyxl, requests, jinja2, python-dotenv）。                                                              |
| `app/__init__.py`         | パッケージ初期化。                                                                                 |
| `app/stock_parser.py`     | CSV/TSV/txt/XLSX のパースと商品コード別在庫合算。Choice は tsv_join_mode で 2 つの TSV を第一カラムでジョイン。                                                              |
| `app/threshold_loader.py` | CSV / XLSX から商品コード・最低在庫数を読み出し。                                               |
| `app/alert_sender.py`     | アラート文の組み立てと ChatWork API 送信（body パラメータで form-urlencoded）。                                                              |


## 6. データ仕様

- **在庫データ**
  - 対象: コマンドラインで渡した**ポータル名のディレクトリ**内の `.csv` / `.tsv` / `.txt` / `.xlsx`。ディレクトリ名がポータル名となり、setting.json の `portals.{ポータル名}` を検索する。
  - **ヘッダーあり**のポータル: setting.json の `portals.{ポータル名}.mapping` で `product_code_column` / `stock_column`（カラム名）を指定する。
  - **ヘッダーなし**のポータル: `has_header: false` と `product_code_column_index` / `stock_column_index`（0 始まり）を指定する。
  - **Choice ポータル（tsv_join_mode）**: TSV ファイル 2 つを第一カラム（数値）でジョインする。末尾が `_change_stock` の TSV（例: stg_product_details_change_stock.tsv）を在庫数として、そうでない TSV（例: stg_product_details.tsv）を返礼品コードとして使用。`stg_` はステージング用のため無視し、`_change_stock` の有無で判別する。カラム位置は `details_product_code_column_index`（103 列目なら 102）, `change_stock_column_index`（4 列目なら 3）で setting.json に指定する。
  - 文字コード・デリミタは自動判別（設定不要）。
  - 同一ポータル内の全ファイルを商品コードで合算する。
- **最低在庫数定義ファイル（stock_manage.csv / stock_manage.xlsx）**
  - パス: `portals.{ポータル名}.min_stock_base_path` で CSV または XLSX ファイルへの**直接パス**を指定する。空文字のポータルは処理対象外（run_all_portals 実行時にスキップ）。
  - 1 行目をヘッダーとみなし、「返礼品コード」「商品コード」等と「最低在庫数」列を参照する。設定はポータルが行い、実行のたびにここから読み出すため、setting.json に最低在庫数の値は持たない。

## 7. 実行方法

### 7.1 ポータル単体で実行

```text
python main.py <ポータル名のディレクトリ> [setting.json のパス]
```

- **ポータル名のディレクトリ**: 在庫データ（CSV/TSV/txt/XLSX）が入ったフォルダのパス。この**ディレクトリ名**（小文字に正規化）で setting.json の `portals.{ポータル名}` を検索し、その `min_stock_base_path` で指定した CSV/XLSX から最低在庫を読み出す。例: `D:\在庫\Amazon` を渡すとポータル名は `amazon` として扱われる。
- `min_stock_base_path` が未設定・空文字のポータルを指定した場合はエラー終了する。

### 7.2 複数ポータルを一括実行

```text
run_all_portals.bat [ベースディレクトリ] [setting.json のパス]
```

または

```text
python run_all_portals.py [ベースディレクトリ] [setting.json のパス]
```

- **ベースディレクトリ**（任意）: 配下にポータル名のディレクトリ（Amazon, Choice 等）が複数あるフォルダのパス。例: `D:\在庫\2025-10-10` の配下に `Amazon`, `Choice` 等のディレクトリがある場合。
  - **引数なしの場合**: `G:\共有ドライブ\★OD\99_Ops\アーカイブ(Stock)` を対象とし、その配下にある日付ディレクトリ（`yyyy-MM-dd` 形式）のうち直近のものをベースディレクトリとして使用する。
- setting.json を読み、`min_stock_base_path` が空でないポータルのみを対象とする。ベースディレクトリ配下に存在する対象ポータル名ディレクトリをアルファベット順でシリアルに処理する。1 ポータルずつ main.py を起動する。
- 環境変数 `CHATWORK_API_TOKEN` に ChatWork API トークンを設定してから実行する。
- 実行頻度は 1 日 1 回想定で、タスクスケジューラ等から上記コマンドを呼び出す。

## 8. 注意事項

- ChatWork トークンは setting.json に記載せず、環境変数 `CHATWORK_API_TOKEN` で渡す。`.env` ファイルで python-dotenv により読み込むこともできる。
- ChatWork API へは `application/x-www-form-urlencoded` 形式で `body` パラメータにメッセージを設定して送信する。
- 最低在庫数は毎回 CSV/XLSX から読み出すため、setting.json には最低在庫の値を持たず、ファイルパス（min_stock_base_path）のみ指定する。
- min_stock_base_path が空文字のポータルは処理対象外とする。main.py 単体実行時に指定した場合はエラー、run_all_portals 実行時はスキップする。
- Excel のシートは先頭シートを参照し、1 行目をヘッダー、2 行目以降をデータとして扱う。
- Choice ポータルは `tsv_join_mode: true` により、TSV 2 ファイルのジョイン処理を行う。末尾 `_change_stock` で在庫用 TSV を判別する。

