# 在庫しきい値アラート 設計書

本設計は [要件定義書.md](要件定義書.md) に基づく。

## 1. 目的

ポータルが指定した最低在庫数未満の商品があった場合、CyberRecords の ChatWork にアラートを出し、担当者がポータル側に連携することで、在庫切れによる販売機会損失を防止する。

## 2. 要件との対応（要件概要）


| 項目      | 内容                                                                                                     |
| ------- | ------------------------------------------------------------------------------------------------------ |
| 最低在庫の設定 | ポータルが指定する商品と最低在庫数は、ポータルごとの Excel（stock_manage.xlsx）で設定する。実行のたびに当該 Excel から読み出す。                        |
| 在庫データ   | 引数で渡したポータル名のディレクトリ配下の CSV / TSV / txt から、商品コードで一意に合算した在庫数を取得する。渡したディレクトリ名で setting.json と Excel を検索する。 |
| アラート条件  | ポータルごとに、合算在庫数が最低在庫数を下回った場合に ChatWork へアラート通知する。                                                        |
| 実行頻度    | 現時点では 1 日 1 回の実行を想定（タスクスケジューラ等で呼び出す）。                                                                  |


## 3. 処理フロー

1. **入力**
  - コマンドライン引数: **ポータル名のディレクトリ**（必須）。在庫データ（CSV/TSV/txt）が格納されたフォルダのパス。**ディレクトリ名**で setting.json のポータル定義と、最低在庫を定義した Excel を検索する。
  - 設定ファイル: `setting.json`（任意で第 2 引数でパス指定、省略時は実行ファイル同階層の `setting.json`）
  - 最低在庫: 実行のたびに `{excel_base_path}\{ポータル名}\stock_manage.xlsx` から読み出す（ポータル名は渡したディレクトリ名）
2. **処理**
  - 渡したディレクトリの**ディレクトリ名**をポータル名とみなし、setting.json の `portals` から同名のポータル定義を検索する。
  - 当該ポータルについて:
    - 渡したディレクトリ内の CSV / TSV / txt を、setting.json で定義した商品コード・在庫数のカラム（名または列番号）でパースし、商品コードごとに在庫数を合算する。
    - `{excel_base_path}\{ポータル名}\stock_manage.xlsx` から商品コードと最低在庫数を読み出す（Excel の 1 行目をヘッダーとし、商品コード列・「最低在庫数」列を参照）。
    - 合算在庫数 < 最低在庫数 の商品をアラート対象としてリストに追加する。
  - アラートが 1 件以上ある場合、setting.json に記載した ChatWork の API ドメイン・エンドポイントを用いてメッセージを送信する。
3. **出力**
  - ChatWork ルームへ、ポータル名・商品コード・現在の合算在庫数・最低在庫数・不足数を含むアラートメッセージを送信する。

## 4. 設定ファイル（setting.json）

- **ChatWork API**
  - `chatwork.api_base_url`: API のベース URL（例: `https://api.chatwork.com`）
  - `chatwork.room_id`: 送信先ルーム ID
  - `chatwork.message_endpoint`: メッセージ送信エンドポイント（例: `/v2/rooms/{room_id}/messages`）
  - `chatwork.mention_members`: メンション対象メンバーの配列（任意）。各要素は `name`（表示名）と `account_id`（ChatWork のアカウント ID）。メッセージ先頭に `[To:account_id] 名前` が付与される。複数指定可。
  - トークンは設定ファイルに持たず、環境変数 `CHATWORK_API_TOKEN` で渡す。
- **Excel のベースパス**
  - `excel_base_path`: stock_manage.xlsx が格納される親ディレクトリ（省略時は `G:\共有ドライブ\★OD\99_在庫管理\しきい値アラート`）。  
  - 実際のファイルパスは `{excel_base_path}\{ポータル名}\stock_manage.xlsx`。  
  - 最低在庫数はここから実行のたびに読み出すため、setting.json に最低在庫数の項目は持たない。
- **ポータル別（在庫データ用）**: `portals.{ポータル名}.mapping` の形式。ポータル名はコマンドラインで渡す「ポータル名のディレクトリ」の**ディレクトリ名**と一致させる（大文字小文字は区別しない）。この名前で Excel パスも検索する。
  - **mapping**（各ポータル配下）:
    - **ヘッダーあり**（通常）: `product_code_column`（商品コードのカラム名）, `stock_column`（在庫数のカラム名）
    - **ヘッダーなし**（例: Choice）: `has_header: false`（ポータル直下または mapping 内）, `product_code_column_index`, `stock_column_index`（0 始まり）
  - **CSV/TSV/TXT の文字コード・デリミタ**: 設定では指定しない。UTF-8 → UTF-8 BOM → CP932 の順で自動判別し、区切りは先頭行からタブ/カンマを自動判定する。

## 5. ディレクトリ・ファイル構成

実行ファイルは `main.py` のみとし、それ以外の Python モジュールは `app` 配下に配置する。


| パス                        | 説明                                                                                        |
| ------------------------- | ----------------------------------------------------------------------------------------- |
| `main.py`                 | **実行ファイル（唯一のエントリポイント）**。引数でポータル名のディレクトリを受け取り、そのディレクトリ名で setting.json と Excel を検索してフローを実行。 |
| `setting.json`            | 上記の設定。ChatWork のドメイン・エンドポイント、ポータル別カラム定義など。                                                |
| `requirements.txt`        | 依存ライブラリ（openpyxl, requests）。                                                              |
| `app/__init__.py`         | パッケージ初期化。                                                                                 |
| `app/stock_parser.py`     | CSV/TSV/txt のパースと商品コード別在庫合算。                                                              |
| `app/threshold_loader.py` | Excel（stock_manage.xlsx）から商品コード・最低在庫数を読み出し。                                               |
| `app/alert_sender.py`     | アラート文の組み立てと ChatWork API 送信。                                                              |


## 6. データ仕様

- **在庫データ**
  - 対象: コマンドラインで渡した**ポータル名のディレクトリ**内の `.csv` / `.tsv` / `.txt`。ディレクトリ名がポータル名となり、setting.json の `portals[].name` および Excel パス（`{excel_base_path}\{ポータル名}\stock_manage.xlsx`）の検索に使う。
  - **ヘッダーあり**のポータル: setting.json の `portals.{ポータル名}.mapping` で `product_code_column` / `stock_column`（カラム名）を指定する。
  - **ヘッダーなし**のポータル（例: Choice）: `has_header: false` と `product_code_column_index` / `stock_column_index`（0 始まり）を指定する。
  - 文字コード・デリミタは自動判別（設定不要）。
  - 同一ポータル内の全ファイルを商品コードで合算する。
- **stock_manage.xlsx（最低在庫）**
  - パス: `G:\共有ドライブ\★OD\99_在庫管理\しきい値アラート\{ポータル名}\stock_manage.xlsx`（または setting.json の `excel_base_path` からの相対）
  - 1 行目をヘッダーとみなし、「商品コード」列と「最低在庫数」列を参照する。設定はポータルが行い、実行のたびにここから読み出すため、setting.json に最低在庫数の項目は持たない。

## 7. 実行方法

```text
python main.py <ポータル名のディレクトリ> [setting.json のパス]
```

- **ポータル名のディレクトリ**: 在庫データ（CSV/TSV/txt）が入ったフォルダのパス。この**ディレクトリ名**で setting.json のポータル定義と、最低在庫の Excel（`{excel_base_path}\{ディレクトリ名}\stock_manage.xlsx`）を検索する。例: `D:\在庫\Choice` を渡すとポータル名は `Choice` として扱われる。
- 環境変数 `CHATWORK_API_TOKEN` に ChatWork API トークンを設定してから実行する。
- 実行頻度は 1 日 1 回想定で、タスクスケジューラ等から上記コマンドを呼び出す。

## 8. 注意事項

- ChatWork トークンは setting.json に記載せず、環境変数で渡す。
- 最低在庫数は毎回 Excel から読み出すため、setting.json には最低在庫に関する項目を設けない。
- Excel のシートは先頭シートを参照し、1 行目をヘッダー、2 行目以降をデータとして扱う。
- ヘッダーなしのポータル（例: Choice）は、`has_header: false` と列番号（0 始まり）で在庫データを指定する。

